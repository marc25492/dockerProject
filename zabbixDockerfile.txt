FROM lampstack
MAINTAINER manclyon

RUN apt-get update -y

#Change work directory - to /usr/local
WORKDIR /opt

#Get Zabbix package from online repo
RUN wget http://repo.zabbix.com/zabbix/3.2/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.2-1+xenial_all.deb

# Install .deb package
RUN dpkg -i zabbix-release_3.2-1+xenial_all.deb
RUN apt-get update
 
# Install stuff
RUN apt-get install zabbix-server-mysql zabbix-frontend-php -y

#Set up the database
RUN service mysql start\
&& mysql -u root -p123 -e "create user 'zabbix';"\
&& mysql -u root -p123 -e "CREATE DATABASE zabbixdb;"\
&& mysql -u root -p123 -e "GRANT ALL privileges on zabbix.* to zabbix@localhost identified by '123';"\
&& mysql -u root -p123 -e "FLUSH PRIVILEGES;"

#WORKDIR database/mysql
#RUN mysql -uzabbix -p123 zabbix < schema.sql
#RUN mysql -uzabbix -p123 zabbix < images.sql
#RUN mysql -uzabbix -p123 zabbix < data.sql

#RUN service zabbix-server restart

#Import initial schema and data + enter password
WORKDIR /usr/share/doc/zabbix-server-mysql
RUN service mysql start \
&& zcat create.sql.gz | mysql -u root -p123 zabbixdb

RUN echo "DBHost=localhost" >> /etc/zabbix/zabbix_server.conf
RUN echo "DBName=zabbix" >> /etc/zabbix/zabbix_server.conf
RUN echo "DBUser=zabbix" >> /etc/zabbix/zabbix_server.conf
RUN echo "DBPassword=zabbix" >> /etc/zabbix/zabbix_server.conf

RUN service apache2 restart
CMD service zabbix-server restart